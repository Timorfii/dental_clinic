{% extends "Main.html" %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–∏ - {{ super() }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–∏</h4>
                </div>
                <div class="card-body">
                    <!-- –í—ã–±–æ—Ä —É—Å–ª—É–≥–∏ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:</label>
                            <select id="serviceSelect" class="form-select">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É --</option>
                                {% for service in services %}
                                <option value="{{ service.id }}">
                                    {{ service.name }} - {{ "%.2f"|format(service.price) }} —Ä—É–±.
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info mb-0">
                                <small>üü¢ –ó–µ–ª–µ–Ω—ã–π - –≤—Ä–µ–º—è —Å–≤–æ–±–æ–¥–Ω–æ<br>‚ö™ –°–µ—Ä—ã–π - –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–æ</small>
                            </div>
                        </div>
                    </div>

                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button id="prevWeek" class="btn btn-outline-primary">
                            ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è
                        </button>
                        <h5 id="currentWeek" class="mb-0 text-center"></h5>
                        <button id="nextWeek" class="btn btn-outline-primary">
                            –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è ‚Üí
                        </button>
                    </div>

                    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
                    <div id="calendar" class="row g-2">
                        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä—å -->
                    </div>

                    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                    <div class="modal fade" id="confirmModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>–í—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ <span id="modalDateTime" class="fw-bold"></span>?</p>
                                    <p>–£—Å–ª—É–≥–∞: <span id="modalService" class="fw-bold"></span></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                    <button type="button" class="btn btn-primary" id="confirmBooking">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentDate = new Date();
let selectedDate = null;
let selectedTime = null;
let selectedService = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
document.addEventListener('DOMContentLoaded', function() {
    updateCalendar();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.getElementById('prevWeek').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() - 7);
        updateCalendar();
    });
    
    document.getElementById('nextWeek').addEventListener('click', () => {
        currentDate.setDate(currentDate.getDate() + 7);
        updateCalendar();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
    document.getElementById('serviceSelect').addEventListener('change', function() {
        selectedService = this.value;
        updateCalendar(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å–ª—É–≥–∏
    });
});

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function updateCalendar() {
    const calendarEl = document.getElementById('calendar');
    const weekTitleEl = document.getElementById('currentWeek');
    
    // –û—á–∏—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    calendarEl.innerHTML = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ–¥–µ–ª–∏
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
    
    weekTitleEl.textContent = `–ù–µ–¥–µ–ª—è ${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏
    for (let i = 0; i < 7; i++) {
        const dayDate = new Date(startOfWeek);
        dayDate.setDate(startOfWeek.getDate() + i);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'col';
        dayEl.innerHTML = `
            <div class="card h-100">
                <div class="card-header text-center ${isToday(dayDate) ? 'bg-light' : ''}">
                    <strong>${getDayName(dayDate)}</strong><br>
                    <small>${formatDate(dayDate)}</small>
                </div>
                <div class="card-body p-2" id="slots-${formatDate(dayDate)}">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        calendarEl.appendChild(dayEl);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
        loadSlotsForDate(formatDate(dayDate));
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã
function loadSlotsForDate(date) {
    fetch(`/api/available_slots/${date}`)
        .then(response => response.json())
        .then(data => {
            const slotsEl = document.getElementById(`slots-${date}`);
            
            if (data.error) {
                slotsEl.innerHTML = `<div class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
                return;
            }
            
            let slotsHTML = '';
            data.slots.forEach(slot => {
                const isAvailable = slot.available && selectedService;
                slotsHTML += `
                    <button class="btn btn-sm w-100 mb-1 ${isAvailable ? 'btn-success' : 'btn-outline-secondary'}" 
                            ${!isAvailable ? 'disabled' : ''}
                            onclick="selectSlot('${date}', '${slot.time}')">
                        ${slot.time}
                    </button>
                `;
            });
            
            slotsEl.innerHTML = slotsHTML || '<div class="text-muted text-center">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>';
        })
        .catch(error => {
            console.error('Error loading slots:', error);
        });
}

// –í—ã–±–æ—Ä —Å–ª–æ—Ç–∞
function selectSlot(date, time) {
    if (!selectedService) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É');
        return;
    }
    
    selectedDate = date;
    selectedTime = time;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    document.getElementById('modalDateTime').textContent = `${date} –≤ ${time}`;
    document.getElementById('modalService').textContent = 
        document.getElementById('serviceSelect').selectedOptions[0].text;
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
document.getElementById('confirmBooking').addEventListener('click', function() {
    if (!selectedDate || !selectedTime || !selectedService) {
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> –ó–∞–ø–∏—Å—å...';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/api/book_slot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            service_id: selectedService,
            date: selectedDate,
            time: selectedTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            updateCalendar();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏');
        console.error('Error:', error);
    })
    .finally(() => {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        this.disabled = false;
        this.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å';
    });
});

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function getDayName(date) {
    const days = ['–í–°', '–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë'];
    return days[date.getDay()];
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}
</script>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
.btn-success {
    font-weight: 500;
}
</style>
{% endblock %}